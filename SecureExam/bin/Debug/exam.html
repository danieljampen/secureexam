<!DOCTYPE html>
<html>
<head lang="en">
	<meta charset="UTF-8">
	<title></title>
	<style>
	.longShizzle { display: inline-block;width: 60em;word-wrap: break-word}
	.hidden { display: none;}
	.questionFieldset {margin-bottom: 10px;}
	</style>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/aes.js"></script>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha256.js"></script>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/core-min.js"></script>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/enc-utf16-min.js"></script>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/enc-base64-min.js"></script>


	<script>
	var PBKDF2ITERATIONS = 1000;
	/*
	 *	FUNCTION decrypt()
	 *	arguments: - (string) divUserKeyDB = div ID where the UserKey Information is written
	 *			   - (string) divSecretStuff = div ID where the encrypted data is stored
	 *			   - (string) divQuestions = div ID where the decrypted data will be written into
	 *
	 *  description: decrypt the questions.
	 */
	function decrypt(divUserKeyDB, divSecretStuff, divQuestions) {
		// load userKeyDB & questionDiv
		var userKeyDB = document.getElementById(divUserKeyDB).innerHTML.split("<br>");
		var questionDiv = document.getElementById(divSecretStuff).innerHTML.split(",");

		// remove empty last entry from userKeyDB
		userKeyDB.pop();
		// split username from secret
		for( i = 0; i < userKeyDB.length; i++) {
			userKeyDB[i] = userKeyDB[i].split(",");
		}

		// Ask for Secret
		var userSecret = prompt("UserCredentials: ");

		// extract Username for comparison with userKeyDB
		var userName = userSecret.substring(0,userSecret.length - 10);

		// get encryptedMasterkey cypher for this user
		var masterkeyCypher;
		var masterkeyIV;
		var saltB64;
		for( i = 0; i < userKeyDB.length; i++ ) {
			if( userName == userKeyDB[i][0]){
				masterkeyCypher = CryptoJS.enc.Hex.parse( userKeyDB[i][1] );
				masterkeyIV = CryptoJS.enc.Hex.parse( userKeyDB[i][2] );
				saltB64 = userKeyDB[i][3];
				break;
			}

		}

		// generate key
		userSecret = userSecret + saltB64;
		var key = CryptoJS.SHA256( userSecret );

		for( i = 0; i < PBKDF2ITERATIONS -1; i ++)
		{
			key = CryptoJS.SHA256(key);
		}

		// WORKS UNTIL HERE

		// decrypt masterkey
	    var masterKeyCipherParams = CryptoJS.lib.CipherParams.create({
	         ciphertext: masterkeyCypher,
	         key: key,
	         iv: masterkeyIV,
	         algorithm: CryptoJS.algo.AES,
	         mode: CryptoJS.mode.CBC,
	         padding: CryptoJS.pad.PKCS7,
	         blockSize: 4,
	         formatter: CryptoJS.format.OpenSSL
		});

		var decMasterKey = CryptoJS.AES.decrypt(masterKeyCipherParams, key, {iv: masterkeyIV});
		var masterKeyString = decMasterKey.toString(CryptoJS.enc.Utf8);
		var masterKey = CryptoJS.enc.Hex.parse(masterKeyString);

		// decrypt questions
		var questionsIV = CryptoJS.enc.Hex.parse( questionDiv[0] );
		var questionsCipher = CryptoJS.enc.Hex.parse( questionDiv[1] );

		var questionsCipherParams = CryptoJS.lib.CipherParams.create({
			ciphertext: questionsCipher,
			key: masterKey,
			iv: questionsIV,
			algorithm: CryptoJS.algo.AES,
			mode: CryptoJS.mode.CBC,
			padding: CryptoJS.pad.PKCS7,
			blockSize: 4,
			formatter: CryptoJS.format.OpenSSL
		});

		var decrypted = CryptoJS.AES.decrypt(questionsCipherParams, masterKey, { iv: questionsIV });
		var decryptedString = decrypted.toString(CryptoJS.enc.Utf8);
		// print questions
		document.getElementById(divQuestions).innerHTML = decryptedString;
	}
	</script>
</head>
<body onload="decrypt('userKeyDB','secretStuff','questions')">
	<fieldset class="hidden">
		<legend>Crypto-Inhalt des HTML Files</legend>
		<h2>Verschlüsselter Text</h1>
		<div id="secretStuff" class="longShizzle">D84197D1C30056AB0B692B3E72BFB0E4,9AF117FD3C6D0A151A40D5E9F50C7997F01886A43AE1B2E9DA74F6D170110429847A865D2226FF0838DD89B3A5FB32F8D3527F0DBA22CD070419E894D7E09D2DA9AE2D1B42899CE92CC62ECD831F3FC70D0BE657DB75856205899840ED4FAD6CD093F2A92A1B66AF4B3B3EE2B17AD16CE96B7271E508D004CBFDDBDE02043E0FCE0076C92F92B26BFF5E5AFBAC55636133796754323826AB69E7DCA56D5F60F6D181417AA284B559A0869FBB19B9DFE86A91444515A244135A5ACFED4D471A54CF36148AF0F206CD3D8E6B12F508FD6076A47A9F00F2760E607B3AB6BA823B586A60C4EFA0E0C819653C218B7E212DF72955EA38F3839E82C7AA5BD442F9BAA38094DE6D1B451934C2933FD340E7891DF38610C6147BFBACEC8BE43AC551682F195E94392E2C21B854CE08DE02E9DD392AE0D4597D098E64B905B68893B8F2A6A727511EBC512CE3B9B7094C3527DFAFC5362784D334D532E09C52EF059B884634780551A1A7BB427909591B1A243B655FC8CEBE75B1804E89A2B119639D86FA3B8DDABE3906AA0F579BFF7CE7E1BDB39C94889BB35DB7C09D12CF5F965EE2BA8009A6F83BE0312B518552DF95AA308E591FAD1CF88ED8DF0693083F0A9B9A0F827BA0A83CD6FDDC7FC405747DB947AB5F77EEC5E723B8E97D1F0381E4DE9D6510FF93CEF03F31969FB73506D768CE94F24E21D02CB185CCB2EA4FD83C092B6A7E68E01D605AF4BFA5E30A40A3ED4610C98303CC47DA3231F13581ED3ECD260CB0BA0C6FBDD0EF4C33AC76D64164B04FC91991DC43F5F53871E5910EDECA68B936944D15D3EED7C8C1F17E88F03EE67CF01D3134ABE267C20CC2A59F2CB0790A4982A16CE690C876813879C3967223B635AE7CB34D67D641CB7F2FA4A41F7377D96BFAF490AE7AD26BD1A9F991BBF31F608B065EE316E20831FA81D88F2395E2AB241D7D4BBA2B4E9B77CB3CE76AAC299B0FB7B7232C29B5EE80D74B1A8557CE19698626A888D52C04360E8AE95DB8AA0DD0E59C63D78FF1ABEC3FD2B9D52155CC91EB8A7B311A4DF8FE37E4B460BC60</div>
		<h2></h2>UserKeyDB</h2>
		<div id="userKeyDB">DanielJampenS12198320,8C4778F754192CF28B2C06CAB727FDBE29E4273561613596A2B493567F8C750484DCC8DB2AAB4B8163849C158F91EA164E4EEDB84D4EAF9670A0F96D9C44ED0DB1627C4352D18A46AAF7067FCD0CC73B,B13007C4A23273DB681949BCE1880D5E,nzYfQBdXqipBNXIu4xhWKbrrIQ6d+ZkiD2RgG8ewxGE=<br>SimonLukesS12198347,9B792DE8AC78386698DB485D62078CF06A04DCFD117AB7AC91F19A902CBA42EBDBD9982F5ABAA196EA64EB7C16195695C7056A289B0400849CAB27F7698BAC11179A0BEFEBD703E03929D8B3C97A2B3F,0B54066D45ADAAE5F38E6FCD376D12FD,PC2jpsDSIVugdAdzWJe2vUWvMyUAg0uTOtxgH31LSNI=<br></div>
	</fieldset>
	<fieldset>
		<legend id="decryptFieldsetLegend">Prüfung</legend>
		<h1></h1>
		<div id="questions" class="longShizzle"></div>
	</fieldset>
</body>
</html>