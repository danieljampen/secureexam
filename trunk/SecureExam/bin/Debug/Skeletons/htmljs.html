<!DOCTYPE html>
<html>
<head lang="en">
	<meta charset="UTF-8">
	<title></title>
	<link href="components/css/site.css" rel="stylesheet" type="text/css">
	<!-- Import JS Libs -->
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/aes.js"></script>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha256.js"></script>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/core-min.js"></script>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/enc-utf16-min.js"></script>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/enc-base64-min.js"></script>
	<script src="https://rawgit.com/eligrey/FileSaver.js/master/FileSaver.min.js"></script>


	<script>
	var userName;
	var userSecret;
	var SHA256ITERATIONS = $SHA256ITERATIONS$;
	/*
	 *	FUNCTION decrypt()
	 *	arguments: - (string) divUserKeyDB = div ID where the UserKey Information is written
	 *			   - (string) divSecretStuff = div ID where the encrypted data is stored
	 *			   - (string) divQuestions = div ID where the decrypted data will be written into
	 *
	 *  description: decrypt the questions.
	 */
	function decrypt(divUserKeyDB, divSecretStuff, divQuestions) {
		// Get Secret
		userSecret = document.getElementById("userSecret").value;
		if( userSecret == "" ) {
			document.getElementById("userSecret").style.border = "1px solid red";
			return;
		}

		// load userKeyDB & questionDiv
		var userKeyDB = document.getElementById(divUserKeyDB).innerHTML.split("<br>");
		var questionDiv = document.getElementById(divSecretStuff).innerHTML.split(",");

		// remove empty last entry from userKeyDB
		userKeyDB.pop();
		// split username from secret
		for( i = 0; i < userKeyDB.length; i++) {
			userKeyDB[i] = userKeyDB[i].split(",");
		}

		// extract Username for comparison with userKeyDB
		userName = userSecret.substring(0,userSecret.length - $RANDOMCHARSINUSERSECRET$);

		// get encryptedMasterkey cypher for this user
		var masterkeyCypher;
		var masterkeyIV;
		var saltB64;
		for( i = 0; i < userKeyDB.length; i++ ) {
			if( userName == userKeyDB[i][0]){
				masterkeyCypher = CryptoJS.enc.Hex.parse( userKeyDB[i][1] );
				masterkeyIV = CryptoJS.enc.Hex.parse( userKeyDB[i][2] );
				saltB64 = userKeyDB[i][3];
				break;
			}

		}

		// generate key
		userSecret = userSecret + saltB64;
		var key = CryptoJS.SHA256( userSecret );

		for( i = 0; i < SHA256ITERATIONS -1; i ++)
		{
			key = CryptoJS.SHA256(key);
		}

		// WORKS UNTIL HERE

		// decrypt masterkey
	    var masterKeyCipherParams = CryptoJS.lib.CipherParams.create({
	         ciphertext: masterkeyCypher,
	         key: key,
	         iv: masterkeyIV,
	         algorithm: CryptoJS.algo.AES,
	         mode: CryptoJS.mode.CBC,
	         padding: CryptoJS.pad.PKCS7,
	         blockSize: 4,
	         formatter: CryptoJS.format.OpenSSL
		});

		var decMasterKey = CryptoJS.AES.decrypt(masterKeyCipherParams, key, {iv: masterkeyIV});
		var masterKeyString = decMasterKey.toString(CryptoJS.enc.Utf8);
		var masterKey = CryptoJS.enc.Hex.parse(masterKeyString);

		// decrypt questions
		var questionsIV = CryptoJS.enc.Hex.parse( questionDiv[0] );
		var questionsCipher = CryptoJS.enc.Hex.parse( questionDiv[1] );

		var questionsCipherParams = CryptoJS.lib.CipherParams.create({
			ciphertext: questionsCipher,
			key: masterKey,
			iv: questionsIV,
			algorithm: CryptoJS.algo.AES,
			mode: CryptoJS.mode.CBC,
			padding: CryptoJS.pad.PKCS7,
			blockSize: 4,
			formatter: CryptoJS.format.OpenSSL
		});

		var decrypted = CryptoJS.AES.decrypt(questionsCipherParams, masterKey, { iv: questionsIV });
		var decryptedString = decrypted.toString(CryptoJS.enc.Utf8);
		// print questions
		document.getElementById(divQuestions).innerHTML = decryptedString;
		document.getElementById(divQuestions).innerHTML += '<p class="questionText center"><button onclick="finishExam()">Prüfung einreichen</button></p>';

		var examDetails = document.getElementById("studentDetails");
		var name = userName.substring(0,userName.length - 9);
		var immnumber = userName.substring(userName.length -9, userName.length);
		examDetails.innerHTML = examDetails.innerHTML.replace("$NAME$", name);
		examDetails.innerHTML = examDetails.innerHTML.replace("$IMMNUMBER$", immnumber);
	}

	function finishExam() {
		if( confirm("Wollen Sie wirklich die Prüfung einreichen? Dies kann nicht rückgängig gemacht werden!")) {
			xml = '<?xml version="1.0" encoding="iso-8859-1"?>';
			xml += '<questions>';
			var examNodes = document.getElementById("exam");
			for( i = 1; i < examNodes.length; i = i + 2 ) {
				xml += '<question>';
				var questionNode = examNodes.childNodes[i];
				var questionText = questionNode.children[0].innerText;
				xml += '<legend>' + questionText + '</legend>';
				var answerTag = questionNode.children[1];
				if( answerTag.children[0].localName === "textarea") {
					xml += '<input type="text">' + answerTag.children[0].value + '</input>';
				}
				else {
					for( j = 0; j < answerTag.children.length; j = j + 2) {
						xml += '<input type="checkbox" ' + (answerTag.children[j].checked == true ? "checked=\"true\" " : "") + '/>';
					}
				}
				xml += '</question>';
			}
			xml += '</questions>';

			var encXml =  CryptoJS.AES.encrypt( xml, userSecret);
			xml = encXml.iv.toString() + "," + encXml.ciphertext.toString();

			var blob = new Blob([xml], {type: "text/plain;charset=utf-8"});
			var res = saveAs(blob, "exam_" + userName + ".xml.enc");

			// set views
			document.getElementById("questions").innerHTML = '<p class="questionText center">Prüfung abgeschlossen!</p>';
		}
	}

	window.onscroll = function(){
		var distance = (this.pageYOffset || document.documentElement.scrollTop)  - (document.documentElement.clientTop || 0);
		if( distance >= 230 ) {
			document.getElementById("header").classList.add("paper");
		}
		else {
			document.getElementById("header").classList.remove("paper");
		}
	};
	</script>
</head>
<body>
	<div class="header" id="header">
		<div class="headerNotes">
			<span class="zhaw">ZHAW School of Engineering</span>
			Verbleibende Zeit:
			<span id="timeLeft">45min 00s</span>
		</div>
		<div class="headerTitle">
			$SUBJECT$: $EXAMTITLE$
		</div>
	</div>
	<div class="examNotes paper" id="examNotes">
		<p id="studentDetails" class="studentDetails">Name: $NAME$ Immatrikulationsnummer: $IMMNUMBER$</p>
		<p class="notes">Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.</p>
	</div>
	<div class="examContainer paper">
		<div id="questions">
				<p class="questionText center">Bitte geben Sie ihr Identifikationspasswort ein!</p>
				<p class="questionText center">
					<input type="text" id="userSecret" size="35"/>
					<button onclick="decrypt('userKeyDB','secretStuff','questions')">Prüfung starten!</button>
				</p>
		</div>
	</div>
	<div class="hidden">
		<div id="secretStuff" class="longShizzle">$ENCRYPTEDDATA$</div>
		<div id="userKeyDB">$USERKEYDB$</div>
	</div>
</body>
</html>