<!DOCTYPE html>
<html>
<head lang="en">
	<meta charset="UTF-8">
	<title></title>
	<link href="components/css/site.css" rel="stylesheet" type="text/css">
	<!-- Import JS Libs -->
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/aes.js"></script>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha256.js"></script>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/core-min.js"></script>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/enc-utf16-min.js"></script>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/enc-base64-min.js"></script>
	<script src="https://rawgit.com/eligrey/FileSaver.js/master/FileSaver.min.js"></script>


	<script>
	var userName;
	var userSecret;
	var seInfos;
	var SHA256ITERATIONS = $SHA256ITERATIONS$;

	/*
	 *	Class secureExamInfos()
	 *	Constructor-Arguments: none
	 *
	 *  description: class stored in localDB.
	 */
	function secureExamInfos() {
		this.examStartTime = new Date();
		this.examEndTime = null;
		this.examStartings = 1;
		this.studentSecret = userSecret;
		this.load = function ( oldSEInfo ) {
			try {
				var dec = CryptoJS.AES.decrypt(oldSEInfo, userSecret);
				var decString = dec.toString(CryptoJS.enc.Utf8);
				var oldData = decString.substring(16,decString.length-1).split(",");
				if( decString.substring(0, 15) === "secureExamInfos" && oldData[3] === userSecret) {
					this.examStartTime = new Date(oldData[0]);
					this.examEndTime = (oldData[1] !== "null")? new Date(oldData[1]): null;
					this.examStartings += Number(oldData[2]);
					this.studentSecret = oldData[3];
				}
			}catch (err) {}
		}
		this.export = function () {
			var exportString = 'secureExamInfos(' + this.examStartTime + ',' + this.examEndTime + ',' + this.examStartings + ',' + this.studentSecret + ')';
			return CryptoJS.AES.encrypt( exportString, userSecret);
		}
	};

	/*
	 *	Class secureDate()
	 *	Constructor-Arguments: - (Date) startDate = inizialize Time of the clock;
	 *
	 *
	 *  description: class to handle save, reliable and non-manipulatable Time.
	 */
	function secureDate( startDate ) {
		var _this = this;
		startDate = new Date(startDate);
		this.timeHistory = new Array();
		this.timeHistory.push(startDate);
		this.internalClockStartTime = startDate;
		this.internalClockSeconds = 0;
		this.internalUpdateInterval = 1000;
		this.internalClockMaxVariance = 25;
		this.inteval = null;


		this.updateInternal = function( ) {
			_this.internalClockSeconds += (secureTime.internalUpdateInterval / 1000);
			if( _this.timeHistory.length == 10) {
				_this.timeHistory.pop();
			}
			_this.timeHistory.push( new Date() );

			var internalTime = _this.getInternalTime();
			if( _this.verifyCurrentTime(internalTime) ) {
				var diff = new Date().getTime()-internalTime.getTime();
				if( diff > 0 ) {
					_this.internalClockStartTime.setTime(_this.internalClockStartTime.getTime()+diff);
					console.log("[secureDate] compensing cpu lag: " + diff + "ms");
				}
			}
		}

		this.getInternalTime = function() {
			var date = new Date( startDate );
			date.setSeconds( date.getSeconds() + this.internalClockSeconds);
			return date;
		}

		this.dateCompare = function( actualTime, timeToVerify ) {
			timeToVerify = new Date( timeToVerify );
			actualTime = new Date( actualTime );
			if( (timeToVerify.getTime()-actualTime.getTime() >= _this.internalClockMaxVariance ) || (timeToVerify.getTime()-actualTime.getTime() <= _this.internalClockMaxVariance ) ) {
				return true;
			}
			return false;
		}

		this.verifyCurrentTime = function ( time ) {
			time = new Date( time );
			var lastTimeInHistory = this.timeHistory[this.timeHistory.length-1];
			var internalTime = this.getInternalTime();

			if( !this.dateCompare( time, lastTimeInHistory ) ) {
				console.log("[secureDate] timeError");
				return false;
			}
			if( !this.dateCompare(time, internalTime )) {
				console.log("[secureDate] timeError");
				return false;
			}

			console.log("[secureDate] time is OUUUUKAYYYY");
			return true;
		}

		this.stop = function () {
			clearInterval(this.inteval);
		}

		this.inteval = window.setInterval(this.updateInternal,1000);
	}

	/*
	 *	FUNCTION decrypt()
	 *	arguments: - (string) divUserKeyDB = div ID where the UserKey Information is written
	 *			   - (string) divSecretStuff = div ID where the encrypted data is stored
	 *			   - (string) divQuestions = div ID where the decrypted data will be written into
	 *
	 *  description: decrypt the questions.
	 */
	function decrypt(divUserKeyDB, divSecretStuff, divQuestions) {
		// Get Secret
		userSecret = document.getElementById("userSecret").value;

		// extract Username for comparison with userKeyDB
		userName = userSecret.substring(0,userSecret.length - $RANDOMCHARSINUSERSECRET$);

		// local DB
		seInfos = new secureExamInfos();
		if( window.localStorage.getItem("secureExam") != null ) {
			seInfos.load(window.localStorage.getItem("secureExam"));
		}

		// check if exam has been done before
		if(seInfos.examEndTime != null ) {
			document.getElementById("questions").innerHTML = '<p class="questionText center">Prüfung bereits abgelegt!</p>';
			return;
		}

		// show loading screen
		document.getElementById(divQuestions).innerHTML = '<p class="questionText center">decrypting questions...</p>';

		if( userSecret == "" ) {
			document.getElementById("userSecret").style.border = "1px solid red";
			return;
		}

		// load userKeyDB & questionDiv
		var userKeyDB = document.getElementById(divUserKeyDB).innerHTML.split("<br>");
		var questionDiv = document.getElementById(divSecretStuff).innerHTML.split(",");

		// remove empty last entry from userKeyDB
		userKeyDB.pop();
		// split username from secret
		for( i = 0; i < userKeyDB.length; i++) {
			userKeyDB[i] = userKeyDB[i].split(",");
		}

		// get encryptedMasterkey cypher for this user
		var masterkeyCypher;
		var masterkeyIV;
		var saltB64;
		for( i = 0; i < userKeyDB.length; i++ ) {
			if( userName == userKeyDB[i][0]){
				masterkeyCypher = CryptoJS.enc.Hex.parse( userKeyDB[i][1] );
				masterkeyIV = CryptoJS.enc.Hex.parse( userKeyDB[i][2] );
				saltB64 = userKeyDB[i][3];
				break;
			}

		}

		// generate key
		var userSecretSalted = userSecret + saltB64;
		var key = CryptoJS.SHA256( userSecretSalted );

		for( i = 0; i < SHA256ITERATIONS -1; i ++)
		{
			key = CryptoJS.SHA256(key);
		}

		// decrypt masterkey
	    var masterKeyCipherParams = CryptoJS.lib.CipherParams.create({
	         ciphertext: masterkeyCypher,
	         key: key,
	         iv: masterkeyIV,
	         algorithm: CryptoJS.algo.AES,
	         mode: CryptoJS.mode.CBC,
	         padding: CryptoJS.pad.PKCS7,
	         blockSize: 4,
	         formatter: CryptoJS.format.OpenSSL
		});

		var decMasterKey = CryptoJS.AES.decrypt(masterKeyCipherParams, key, {iv: masterkeyIV});
		var masterKeyString = decMasterKey.toString(CryptoJS.enc.Utf8);
		var masterKey = CryptoJS.enc.Hex.parse(masterKeyString);

		// decrypt questions
		var questionsIV = CryptoJS.enc.Hex.parse( questionDiv[0] );
		var questionsCipher = CryptoJS.enc.Hex.parse( questionDiv[1] );

		var questionsCipherParams = CryptoJS.lib.CipherParams.create({
			ciphertext: questionsCipher,
			key: masterKey,
			iv: questionsIV,
			algorithm: CryptoJS.algo.AES,
			mode: CryptoJS.mode.CBC,
			padding: CryptoJS.pad.PKCS7,
			blockSize: 4,
			formatter: CryptoJS.format.OpenSSL
		});

		var decrypted = CryptoJS.AES.decrypt(questionsCipherParams, masterKey, { iv: questionsIV });
		var decryptedString = decrypted.toString(CryptoJS.enc.Utf8);

		window.localStorage.setItem("secureExam", seInfos.export());

		// print questions
		document.getElementById(divQuestions).innerHTML = decryptedString;
		document.getElementById("finishButton").innerHTML = '<button onclick="finishExam()">Prüfung einreichen</button>';

		var examDetails = document.getElementById("studentDetails");
		var name = userName.substring(0,userName.length - 9);
		var immnumber = userName.substring(userName.length -9, userName.length);
		examDetails.innerHTML = examDetails.innerHTML.replace("$NAME$", name);
		examDetails.innerHTML = examDetails.innerHTML.replace("$IMMNUMBER$", immnumber);

		document.getElementById("studentDetails").classList.remove("hidden");
	}

	/*
	 *	FUNCTION finishExam()
	 *	arguments: none
	 *
	 *  description: finish the Exam, set and store examEndTime, export questions to encrypted xml download.
	 */
	function finishExam() {
		if( confirm("Wollen Sie wirklich die Prüfung einreichen? Dies kann nicht rückgängig gemacht werden!")) {
			seInfos.examEndTime = new Date();

			xml = '<?xml version="1.0" encoding="iso-8859-1"?>';
			xml += '<exam>';
			xml += '<student>';
			xml += '<name>' + userName.substring(0,userName.length -9) + '</name>';
			xml += '<nr>' + userName.substring(userName.length -9, userName.length) + '</nr>';
			xml += '</student>';
			xml += '<examInfos>';
			xml += '<startTime>' + seInfos.examStartTime.toUTCString() + '</startTime>';
			xml += '<endTime>' + seInfos.examStartTime.toUTCString() + '</endTime>';
			xml += '<examStartings>' + seInfos.examStartings + '</examStartings>';
			xml += '</examInfos>';
			xml += '<questions>';
			var examNodes = document.getElementById("exam");
			for( i = 1; i < examNodes.length; i = i + 2 ) {
				xml += '<question>';
				var questionNode = examNodes.childNodes[i];
				var questionText = questionNode.children[0].innerText;
				xml += '<legend>' + questionText + '</legend>';
				var answerTag = questionNode.children[1];
				if( answerTag.children[0].localName === "textarea") {
					xml += '<input type="text">' + answerTag.children[0].value + '</input>';
				}
				else {
					for( j = 0; j < answerTag.children.length; j = j + 2) {
						xml += '<input type="checkbox" ' + (answerTag.children[j].checked == true ? "checked=\"true\" " : "") + '/>';
					}
				}
				xml += '</question>';
			}
			xml += '</questions>';
			xml += '</exam>';

			//var encXml =  CryptoJS.AES.encrypt( xml, userSecret);
			//xml = encXml.iv.toString() + "," + encXml.ciphertext.toString();

			var blob = new Blob([xml], {type: "text/plain;charset=utf-8"});
			var res = saveAs(blob, "exam_" + userName + ".xml.enc");

			window.localStorage.setItem("secureExam", seInfos.export());

			// set views
			document.getElementById("questions").innerHTML = '<p class="questionText center">Prüfung abgeschlossen!</p>';
		}
	}

	function keyUpUserSecret(e) {
		if(e.keyCode == 13) {
			decrypt('userKeyDB','secretStuff','questions');
		}
	}

	var secureTime = new secureDate(new Date());
	function verifyTime() {
		if( !secureTime.verifyCurrentTime(new Date()) ) {
			document.getElementById("questions").innerHTML = '<p class="questionText center">Prüfungsabbruch, Zeitmanipulation entdeckt!</p>';
			clearInterval(secureTimeInverval);
			secureTime.stop();
		}
	}

	var secureTimeInverval = window.setInterval(verifyTime,1000);
	</script>
</head>
<body>
	<div class="header paper" id="header">
		<div class="headerNotes">
			<span class="zhaw">ZHAW School of Engineering</span>
			Verbleibende Zeit:
			<span id="timeLeft">45min 00s</span>
		</div>
		<div class="headerTitle">
			$SUBJECT$: $EXAMTITLE$
			<p id="studentDetails" class="headerStudentInfo hidden">Name: $NAME$ Immatrikulationsnummer: $IMMNUMBER$</p>
		</div>
		<div id="finishButton"></div>
	</div>
	<div class="examNotes paper" id="examNotes">
		<p class="notes">Prüfungshinweise:
			Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.</p>
	</div>
	<div class="examContainer paper">
		<div id="questions">
				<p class="questionText center">Bitte geben Sie ihr Identifikationspasswort ein!</p>
				<p class="questionText center">
					<input type="text" id="userSecret" size="35" onkeyup="return keyUpUserSecret(event)"/>
					<button onclick="decrypt('userKeyDB','secretStuff','questions')">Prüfung starten!</button>
				</p>
		</div>
	</div>
	<div class="hidden">
		<div id="secretStuff" class="longShizzle">$ENCRYPTEDDATA$</div>
		<div id="userKeyDB">$USERKEYDB$</div>
	</div>
</body>
</html>